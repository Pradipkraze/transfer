import geopandas as gpd
import pandas as pd
import os

# Define paths
input_folder = "overture"  # Folder containing GeoParquet files
usa_shp_path = "data_folder/usa.shp"  # Path to the USA shapefile
output_parquet = "overlapping_polygons.parquet"  # Output Parquet file

# Load the USA shapefile
usa_gdf = gpd.read_file(usa_shp_path)
usa_geometry = usa_gdf.unary_union  # Combine into a single geometry for efficient checking

# Create or clear the output file
if os.path.exists(output_parquet):
    os.remove(output_parquet)

# Iterate through the GeoParquet files in the folder
for filename in os.listdir(input_folder):
    if filename.endswith(".parquet"):
        file_path = os.path.join(input_folder, filename)
        
        # Read the GeoParquet file in chunks for memory efficiency
        polygons_gdf = gpd.read_parquet(file_path)
        
        # Filter polygons that overlap with the USA geometry
        overlapping_polygons = polygons_gdf[polygons_gdf.geometry.intersects(usa_geometry)]
        
        # Append overlapping polygons to the output Parquet file
        if not overlapping_polygons.empty:
            overlapping_polygons.to_parquet(output_parquet, engine="pyarrow", compression="snappy", index=False, append=True)

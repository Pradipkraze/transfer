import geopandas as gpd
import os
from pyarrow import parquet as pq
from pyarrow import Table

# Define paths
input_folder = "overture"  # Folder containing GeoParquet files
usa_shp_path = "data_folder/usa.shp"  # Path to the USA shapefile
output_parquet = "overlapping_polygons.parquet"  # Output Parquet file

# Load the USA shapefile
usa_gdf = gpd.read_file(usa_shp_path)
usa_geometry = usa_gdf.unary_union  # Combine into a single geometry for efficient checking

# Initialize the output file if it doesn't exist
if os.path.exists(output_parquet):
    os.remove(output_parquet)

# Iterate through the GeoParquet files in the folder
for filename in os.listdir(input_folder):
    if filename.endswith(".parquet"):
        file_path = os.path.join(input_folder, filename)
        
        # Read the GeoParquet file
        polygons_gdf = gpd.read_parquet(file_path)
        
        # Filter polygons that overlap with the USA geometry
        overlapping_polygons = polygons_gdf[polygons_gdf.geometry.intersects(usa_geometry)]
        
        if not overlapping_polygons.empty:
            # Convert to PyArrow Table for appending
            table = Table.from_pandas(overlapping_polygons)
            
            if not os.path.exists(output_parquet):
                # Write the first batch
                pq.write_table(table, output_parquet, compression='snappy')
            else:
                # Append subsequent batches
                with pq.ParquetWriter(output_parquet, table.schema, compression='snappy') as writer:
                    writer.write_table(table)

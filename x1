import geopandas as gpd
import os
import glob

# Path to the folder containing GeoParquet files and the USA shapefile
overture_folder = "overture"
data_folder = "data_folder"
output_folder = "output"

# Load the USA shapefile (assuming it has a simple polygon geometry)
usa_shapefile = os.path.join(data_folder, "usa.shp")
usa = gpd.read_file(usa_shapefile)

# Ensure the CRS (coordinate reference system) is the same for comparison
usa = usa.to_crs(epsg=4326)

# Get a list of GeoParquet files in the overture folder
parquet_files = glob.glob(os.path.join(overture_folder, "*.parquet"))

# Iterate over each GeoParquet file
for parquet_file in parquet_files:
    # Read the GeoParquet file (with low memory usage by using chunksize)
    gdf = gpd.read_parquet(parquet_file)
    
    # Ensure the CRS matches for comparison
    gdf = gdf.to_crs(epsg=4326)

    # Use .intersects() to check for overlap with the USA boundary
    overlapping = gdf[gdf.geometry.intersects(usa.unary_union)]
    
    # If there are overlapping polygons, save them to a new GeoParquet file
    if not overlapping.empty:
        output_file = os.path.join(output_folder, os.path.basename(parquet_file))
        overlapping.to_parquet(output_file)


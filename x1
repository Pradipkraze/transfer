import geopandas as gpd
import os
import pyarrow as pa
import pyarrow.parquet as pq

# Define paths
input_folder = "overture"  # Folder containing GeoParquet files
usa_shp_path = "data_folder/usa.shp"  # Path to the USA shapefile
output_parquet = "overlapping_polygons.parquet"  # Output Parquet file

# Load the USA shapefile
usa_gdf = gpd.read_file(usa_shp_path)
usa_geometry = usa_gdf.unary_union  # Combine into a single geometry for efficient checking

# Initialize the ParquetWriter
writer = None

try:
    # Iterate through the GeoParquet files in the folder
    for filename in os.listdir(input_folder):
        if filename.endswith(".parquet"):
            file_path = os.path.join(input_folder, filename)
            
            # Read the GeoParquet file
            polygons_gdf = gpd.read_parquet(file_path)
            
            # Filter polygons that overlap with the USA geometry
            overlapping_polygons = polygons_gdf[polygons_gdf.geometry.intersects(usa_geometry)]
            
            if not overlapping_polygons.empty:
                # Convert to PyArrow Table
                table = pa.Table.from_pandas(overlapping_polygons)
                
                # Initialize or append using the same writer
                if writer is None:
                    # Open the writer with the schema of the first table
                    writer = pq.ParquetWriter(output_parquet, table.schema, compression='snappy')
                
                # Write the table to the Parquet file
                writer.write_table(table)
finally:
    # Close the writer after processing all files
    if writer is not None:
        writer.close()

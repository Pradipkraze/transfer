import geopandas as gpd
import pandas as pd
import os

# Define input and output folders
input_folder = 'path/to/input/folder'
data_folder = 'path/to/data/folder'
output_folder = 'path/to/output/folder'

# Load USA shapefile
usa_gdf = gpd.read_file(os.path.join(data_folder, 'usa.shp'))

# Iterate through geoparquet files in input folder
for file in os.listdir(input_folder):
    if file.endswith('.parquet'):
        # Load geoparquet file
        gdf = gpd.read_parquet(os.path.join(input_folder, file))

        # Check for overlaps with USA shapefile
        overlaps = gpd.sjoin(gdf, usa_gdf, how='inner', op='intersects')

        # Write overlapping polygons to parquet file
        if not os.path.exists(output_folder):
            os.makedirs(output_folder)
        output_file = os.path.join(output_folder, f'{file[:-8]}_overlaps.parquet')
        overlaps.to_parquet(output_file, mode='a', compression='snappy')

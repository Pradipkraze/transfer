import geopandas as gpd
import os
from shapely import wkt
import pandas as pd

# Paths to the folders
input_folder = "path_to_input_folder"
data_folder = "path_to_data_folder"
output_parquet = "output_file.parquet"
usa_shapefile = os.path.join(data_folder, "usa.shp")

# Read the USA shapefile to check for overlaps
usa = gpd.read_file(usa_shapefile)

# Ensure the CRS of the USA shapefile and GeoParquet files match
usa = usa.to_crs(epsg=4326)

# Iterate over each GeoParquet file in the input folder
for filename in os.listdir(input_folder):
    if filename.endswith(".parquet"):
        file_path = os.path.join(input_folder, filename)
        
        # Read the current GeoParquet file
        gdf = gpd.read_parquet(file_path)
        
        # Convert WKT column to geometry (assuming the column name is 'wkt')
        gdf['geometry'] = gdf['wkt'].apply(wkt.loads)
        gdf = gpd.GeoDataFrame(gdf, geometry='geometry', crs='EPSG:4326')
        
        # Check for overlaps with USA polygons
        overlap_gdf = gdf[gdf.geometry.intersects(usa.unary_union)]
        
        # Append the results to the output Parquet file
        if not overlap_gdf.empty:
            # Append mode for large data
            if os.path.exists(output_parquet):
                overlap_gdf.to_parquet(output_parquet, append=True, index=False)
            else:
                overlap_gdf.to_parquet(output_parquet, index=False)

print("Processing completed and data appended to Parquet.")

import pandas as pd
import rasterio
from rasterio.sample import sample_gen

def get_raster_values(csv_path, tiff_path, output_csv):
    # Read CSV file into a DataFrame
    df = pd.read_csv(csv_path)
    
    # Ensure the CSV has the required columns
    if 'x' not in df.columns or 'y' not in df.columns:
        raise ValueError("CSV must contain 'x' and 'y' columns.")
    
    # Open the GeoTIFF file
    with rasterio.open(tiff_path) as src:
        # Create generator for coordinate pairs
        coordinates = [(x, y) for x, y in zip(df['x'], df['y'])]
        
        # Sample raster values
        raster_values = list(src.sample(coordinates))
        
    # Flatten the sampled values (handles multi-band rasters)
    df['raster_value'] = [val[0] if len(val) == 1 else val for val in raster_values]
    
    # Save the results to a new CSV
    df.to_csv(output_csv, index=False)
    print(f"Raster values have been saved to {output_csv}")

# Paths to the input and output files
csv_path = 'coordinates.csv'
tiff_path = 'raster.tif'
output_csv = 'output_with_raster_values.csv'

# Run the function
get_raster_values(csv_path, tiff_path, output_csv)
